# Mips Circuit


This is a proof of concept (PoC) for zkmips implemented using the Cannon simulator, Zokrates DSL, and Groth16. It supports the full execution of Minigeth, outputs the entire instruction sequence, generates proofs for each instruction, and submits them to an on-chain contract for verification.

Unlike other zkVM projects, we didn't rush to define the proof system we needed initially. Instead, through this PoC, we aimed to understand the scale and challenges of the proofs required for using zkmips as a zk virtual machine for general computation. Now that this PoC is ready, we plan to release a testnet version based on an entirely new proof system in six months.
## Prerequisite

- Install [Rust](https://www.rust-lang.org/tools/install)

- Install [Go](https://go.dev/doc/install)

- Install Make

- Install [Zokrates](https://zokrates.github.io/gettingstarted.html)

- Postgres DB

  - Install [postgres](https://www.postgresql.org/download/)
  - Install [pgadmin(optional)](https://www.pgadmin.org/download/) :Using the pgadmin GUI,it could manage the database visual graphically and easily.
  - Create Tables:

  ```
  DROP TABLE IF EXISTS f_traces;
  CREATE TABLE f_traces
  (
      f_id           bigserial PRIMARY KEY,
      f_trace        jsonb                    NOT NULL,
      f_created_at   TIMESTAMP with time zone NOT NULL DEFAULT now()
  );
  
  DROP TABLE IF EXISTS t_block_witness_cloud;
  CREATE TABLE t_block_witness_cloud
  (
      f_id             bigserial PRIMARY KEY,
      f_block          BIGINT NOT NULL,
      f_version        BIGINT NOT NULL,
      f_object_key     text   NOT NULL,
      f_object_witness text   NOT NULL
  );
  
  DROP TABLE IF EXISTS t_prover_job_queue_cloud;
  CREATE TABLE t_prover_job_queue_cloud
  (
      f_id           bigserial PRIMARY KEY,
      f_job_status   INTEGER                  NOT NULL,
      f_job_priority INTEGER                  NOT NULL,
      f_job_type     TEXT                     NOT NULL,
      f_created_at   timestamp with time zone NOT NULL DEFAULT now(),
      f_version      BIGINT                   NOT NULL,
      f_updated_by   TEXT                     NOT NULL,
      f_updated_at   timestamp with time zone NOT NULL,
      f_first_block  BIGINT                   NOT NULL,
      f_last_block   BIGINT                   NOT NULL,
      f_object_key   TEXT                     NOT NULL,
      f_object_job   TEXT                     NOT NULL
  );
  
  DROP TABLE IF EXISTS t_proofs;
  CREATE TABLE t_proofs
  (
      f_id           bigserial PRIMARY KEY,
      f_block_number BIGINT                   NOT NULL,
      f_proof        jsonb                    NOT NULL,
      f_created_at   TIMESTAMP with time zone NOT NULL DEFAULT now()
  );
  
  DROP TABLE IF EXISTS t_witness_block_number;
  CREATE TABLE t_witness_block_number
  (
      f_id           bigserial PRIMARY KEY,
      f_block     BIGINT                   NOT NULL
  );
  
  DROP TABLE IF EXISTS t_proof_block_number;
  CREATE TABLE t_proof_block_number
  (
      f_id           bigserial PRIMARY KEY,
      f_block     BIGINT                   NOT NULL
  );
  
  DROP TABLE IF EXISTS t_verified_proof_block_number;
  CREATE TABLE t_verified_proof_block_number
  (
      f_id           bigserial PRIMARY KEY,
      f_block       BIGINT                    NOT NULL
  );
  ```

  The id of first execution trace(<first_execution_trace_id>) to be verified or proved can be specified  by following commands:	

  ```
  INSERT INTO t_witness_block_number(f_block) VALUES(${<first_execution_trace_id>});
  
  INSERT INTO t_proof_block_number(f_block) VALUES(${$(<first_execution_trace_id>});
  ```

- Program Execution Trace

  Generating the program execution trace by [cannon-mips](https://github.com/zkMIPS/cannon-mips/tree/mipsevm-minigeth-trace#readme)

- Compile MIPS VM circuit using Zokrates 

  ```
  $ pushd core/lib/circuit
  $ zokrates compile -i mips_vm_poseidon.zok
  $ zokrates setup
  $ popd
  ```

## Deploy Verifier Contract

We have deployed a goerli verify contract at: 0x1062077b532884ef8a66a6c700a608f419db96fa. Developers can use this to verify the proof.

## Witness Generator

1. Setting the environment variables:

   ```
   $ source ./setenv.bash
   ```

   Or add following code to .bashrc file

   ```
   export DATABASE_URL=postgresql://<user>:<password>@<ip>:<port>/<db> 
   export DATABASE_POOL_SIZE=10
   export API_PROVER_PORT=8088
   export API_PROVER_URL=http://127.0.0.1:8088
   export API_PROVER_SECRET_AUTH=sample
   export PROVER_PROVER_HEARTBEAT_INTERVAL=1000
   export PROVER_PROVER_CYCLE_WAIT=500
   export PROVER_PROVER_REQUEST_TIMEOUT=10
   export PROVER_PROVER_DIE_AFTER_PROOF=false
   export PROVER_CORE_GONE_TIMEOUT=60000
   export PROVER_CORE_IDLE_PROVERS=1
   export PROVER_WITNESS_GENERATOR_PREPARE_DATA_INTERVAL=500
   export PROVER_WITNESS_GENERATOR_WITNESS_GENERATORS=2
   export CIRCUIT_FILE_PATH=${PWD}/core/lib/circuit/out # generated by zokrates compile -i mips_vm_poseidon.zok
   export CIRCUIT_ABI_FILE_PATH=${PWD}/core/lib/circuit/abi.json # generated by zokrates compile -i mips_vm_poseidon.zok
   export RUST_LOG=warn
   export VERIFIER_CHAIN_URL=VERIFIER_CHAIN_URL=https://goerli.infura.io/v3/e4903a8305824888b3d9ea0e7760b31e # chain url where the verifier contract deployed
   export VERIFIER_CONTRACT_ADDRESS=0x1062077b532884ef8a66a6c700a608f419db96fa # verifier contract address
   export VERIFIER_ACCOUNT=b75dc70f894ef8bbd8cbb6d9f70c146b87f53cdb959f0ab6ac272a8b33e767f2 # your goerli account private key
   export VERIFIER_ABI_PATH=${PWD}/contract/verifier/g16/verifier
   export CHAIN_ETH_NETWORK=rinkeby
   export CIRCUIT_PROVING_KEY_PATH=${PWD}/core/lib/circuit/proving.key # generated by: zokrates compile -i mips_vm_poseidon.zok
   ```

   **NOTE: you should use your own Postgres database url to replace the relative fields in DATABASE_URL variable in both cases**

2. Compile the witness generator

   ```
   $ pushd core/bin/server
   $ cargo build --release
   $ popd
   ```

3. Running the witness generator

   ```
   $ nohup ./target/release/server > server.output 2>&1 &
   ```

## Prover

1. Setting the environment variables

   ```
   $ source ./setenv.bash
   ```

2. Compile the prover 

   ```
   $ pushd core/bin/prover
   $ cargo build --release
   $ popd
   ```

3. Running the prover

   ```
   $ nohup ./target/release/prover > prover.output 2>&1 &
   ```

   